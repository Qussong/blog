# Stable Diffusion API í†µì‹ 

### ğŸ“ŒAPI í†µì‹  ì½”ë“œ (python ver)
#### ì½”ë“œ
```python
import requests
import base64

# ì„œë²„ ì£¼ì†Œ
url = 'http://127.0.0.1:7860/sdapi/v1/txt2img'

# í”„ë¡¬í”„íŠ¸ ì„¤ì •
payload = {
    "prompt": "a fluffy white cat lying on a wooden floor, natural sunlight from the window, photorealistic, ultra detailed, 8k, soft shadow, close-up",
    "negative_prompt": "low quality, blurry, deformed, bad anatomy, bad eyes, cross-eyed, asymmetrical eyes, mutated eyes, fused eyes, extra eyes, extra limbs, cropped, out of frame, watermark, text, nsfw, unnatural colors",
    "steps": 25,
    "cfg_scale": 7.5,
    "sampler_name": "DPM++ 2M",
    "scheduler": "Karras",
}

response = requests.post(url, json=payload)

# base64 ì´ë¯¸ì§€ ì¶”ì¶œ
r = response.json()
image_data = r['images'][0]

# íŒŒì¼ë¡œ ì €ì¥
with open("output.png", "wb") as f:
    f.write(base64.b64decode(image_data))
```
#### ê²°ê³¼ë¬¼
![ìŠ¤í…Œì´ë¸” ë””í“¨ì „ ê²°ê³¼ë¬¼](img/post/250704/output.png)

#### ì½”ë“œ ë¶„ì„
sd webui api ì— í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ë¥¼ POST ìš”ì²­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ì½”ë“œë‹¤.</br>
ê²°ê³¼ ì´ë¯¸ì§€ë¥¼ base64ë¡œ ë°›ì•„ì™€ pngë¡œ ì €ì¥í•˜ë©° ì „ì²´ íë¦„ì„ ë‹´ê³  ìˆë‹¤.</br>
```plainText
1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
2. ìš”ì²­ URL ì„¤ì •
3. í”„ë¡¬í”„íŠ¸ì™€ ì„¤ì • íŒŒë¼ë¯¸í„° ì •ì˜
4. ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ ì „ì†¡
5. ì‘ë‹µ ë°›ì•„ ì´ë¯¸ì§€ ì¶”ì¶œ ë° ë””ì½”ë”©
6. ì´ë¯¸ì§€ ì €ì¥
```
1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸</br>
**request** : HTTP ìš”ì²­ì„ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬</br> 
**base64** : ì‘ë‹µ ì´ë¯¸ì§€ê°€ ë¬¸ìì—´ í˜•ì‹ìœ¼ë¡œ ì „ë‹¬ë˜ë¯€ë¡œ ì´ë¥¼ ë””ì½”ë”©í•˜ê¸° ìœ„í•´ ì‚¬ìš©</br>
2. ìš”ì²­ URL ì„¤ì •</br>
    SD webui ì—ì„œ ì œê³µí•˜ëŠ” REST API ì£¼ì†Œ</br>
    ```plainText
    url = 'http://127.0.0.1:7860/sdapi/v1/txt2img'
    ```
3. í”„ë¡¬í”„íŠ¸ì™€ ì„¤ì • íŒŒë¼ë¯¸í„° ì •ì˜</br>
    ```python
    payload = {
        "prompt": "...",              # ìƒì„±í•  ì´ë¯¸ì§€ì— ëŒ€í•œ ì„¤ëª…
        "negative_prompt": "...",     # í”¼í•˜ê³  ì‹¶ì€ ìš”ì†Œ
        "steps": 25,                  # ë””í“¨ì „ ë°˜ë³µ ìˆ˜ (ë” ë§ì„ìˆ˜ë¡ í’ˆì§ˆâ†‘, ì†ë„â†“)
        "cfg_scale": 7.5,             # í”„ë¡¬í”„íŠ¸ì— ëŒ€í•œ ì¶©ì‹¤ë„ (7~10 ê¶Œì¥)
        "sampler_name": "DPM++ 2M",   # ìƒ˜í”Œë§ ì•Œê³ ë¦¬ì¦˜
        "scheduler": "Karras"         # ìƒ˜í”Œë§ ìŠ¤ì¼€ì¤„ëŸ¬ (ë…¸ì´ì¦ˆ ë¶„í¬ ë°©ì‹)
    }
    ```
4. ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ ì „ì†¡</br>
    POST ë°©ì‹ìœ¼ë¡œ API í˜¸ì¶œí•˜ê³  JSON í˜•ì‹ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ ë°ì´í„°ë¥¼ ì „ì†¡í•œë‹¤.</br>
    ```python
    response = requests.post(url, json=payload)
    ```
5. ì‘ë‹µ ë°›ì•„ ì´ë¯¸ì§€ ì¶”ì¶œ ë° ë””ì½”ë”©</br>
    ì‘ë‹µì€ JSON í˜•íƒœì´ë©° images í‚¤ ì•ˆì— base64 ë¬¸ìì—´ ì´ë¯¸ì§€ê°€ ë°°ì—´ë¡œ ë“¤ì–´ ìˆë‹¤.</br>
    ```python
    r = response.json()
    image_data = r['images'][0] # ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ì„ íƒ
    ```
6. ì´ë¯¸ì§€ ì €ì¥</br>
    base64 ë¬¸ìì—´ -> ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¡œ ë³€í™˜ í›„ output.png íŒŒì¼ë¡œ ì €ì¥</br>
    ```python
    with open("output.png", "wb") as f:
        f.write(base64.b64decode(image_data))
    ```

### ğŸ“Œbase64
Base64ëŠ” ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ í…ìŠ¤íŠ¸ë¡œ ì•ˆì „í•˜ê²Œ ë°”ê¾¸ëŠ” ë°©ë²•ì´ë‹¤.</br>
ì»´í“¨í„°ê°€ ì´í•´í•œ ì´ì§„ ë°ì´í„°(0ê³¼1)ì„ ì‚¬ëŒì´ ì½ì„ ìˆ˜ ìˆëŠ” ë¬¸ìë¡œ ë°”ê¾¸ëŠ” ì¸ì½”ë”© ë°©ì‹ìœ¼ë¡œ, íŠ¹íˆ **ì´ë¯¸ì§€, ì˜¤ë””ì˜¤, íŒŒì¼**ì²˜ëŸ¼ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ **í…ìŠ¤íŠ¸ ê¸°ë°˜ ì‹œìŠ¤í…œ**(ì´ë©”ì¼, JSON, HTML)ì—ì„œ ì•ˆì „í•˜ê²Œ ì „ì†¡í•˜ê±°ë‚˜ ì €ì¥í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ì—­í• ì„ í•œë‹¤.</br>

#### í•µì‹¬ê°œë…
1. ëª©ì  : ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ í…ìŠ¤íŠ¸ë¡œ ì•ˆì „í•˜ê²Œ ë³€í™˜</br>
2. ì‚¬ìš© ë¬¸ì : A~Z, a~z, 0~9, +, / (ì´ 64ê°œ)</br>
3. ì´ë¦„ ì˜ë¯¸ : 64ê°œì˜ ë¬¸ìë§Œ ì‚¬ìš©í•˜ê¸°ì— base64</br>
4. íŒ¨ë”© ë¬¸ì : '='ê¸°í˜¸ë¡œ ëì„ ì±„ì›Œ ê¸¸ì´ë¥¼ ë§ì¶˜ë‹¤.</br>
(íŒ¨ë”© ë¬¸ìë¡œ '='ì„ ì‚¬ìš©í•˜ì§€ë§Œ í•´ë‹¹ ê¸°í˜¸ëŠ” ì¸ì½”ë”© ëŒ€ìƒì´ ì•„ë‹ˆë¼ í¬ë§·ì„ ë§ì¶”ê¸° ìœ„í•œ íŒ¨ë”© ë¬¸ìì´ê¸°ì— 64ê°œì˜ ë¬¸ìë§Œì„ ì‚¬ìš©í•œë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.)</br>

### ğŸ“ŒREST API
ì›¹ì—ì„œ **ìì›**ì„ HTTPë¡œ **ì¡°ì‘**í•˜ëŠ” ë°©ì‹</br>
RESTëŠ” API ì¤‘ì—ì„œ ì›¹ì—ì„œ ê°€ì¥ ë„ë¦¬ ì“°ì´ëŠ” ëŒ€í™” ë°©ì‹ì´ë‹¤.</br>

#### API ë€?
Application Programing Interface</br>
ì†Œí”„íŠ¸ì›¨ì–´ â†” ì†Œí”„íŠ¸ì›¨ì–´ ê°„ì˜ ëŒ€í™” ë°©ì‹ìœ¼ë¡œ, ì†Œí”„íŠ¸ì›¨ì–´ë¼ë¦¬ ì„œë¡œ ëŒ€í™”í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê·œì¹™(ì¸í„°í˜ì´ìŠ¤)ë‹¤.</br>

#### ìì›ì´ë€?
REST ì—ì„œ ë§í•˜ëŠ” ìì›ì€ "ì„œë²„ê°€ ê°€ì§€ê³  ìˆê³ , í´ë¼ê°€ ì ‘ê·¼í•˜ê±°ë‚˜ ì¡°ì‘í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ê²ƒ"ì„ ê°€ë¦¬í‚¨ë‹¤.</br>

#### ì¡°ì‘ì´ë€?
RESTëŠ” HTTP ë©”ì„œë“œë¥¼ í†µí•´ ìì›ì„ ì¡°ì‘í•œë‹¤.</br>
- GET : ìì› ì¡°íšŒ
- POST : ìì› ìƒì„±
- PUT : ìì› ì „ì²´ ìˆ˜ì •
- PATCH : ìì› ì¼ë¶€ ìˆ˜ì •
- DELETE : ìì› ì‚­ì œ

REST API ëŠ” ì›¹ ê¸°ë°˜ì˜ ì†Œí”„íŠ¸ì›¨ì–´ ê°„ í†µì‹  ê·œì•½ì´ë©°, í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„(Web API)ì˜ ìì›ì„ HTTP ë°©ì‹ìœ¼ë¡œ ì¡°ì‘í•˜ëŠ” êµ¬ì¡°ë‹¤.</br>
ì›¹ì€ ë‹¨ìˆœí•œ ë¸Œë¼ìš°ì €ê°€ ì•„ë‹ˆë¼, APIë¥¼ ì œê³µí•˜ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ì‹œìŠ¤í…œìœ¼ë¡œ ì´í•´í•´ì•¼ í•œë‹¤.</br>

### ğŸ“ŒREST API í…ŒìŠ¤íŠ¸

#### Server
```python
from flask import Flask, request, jsonify

app = Flask(__name__)

@app.route('/hello', methods=['GET'])
def say_hello():
    name = request.args.get('name', 'Gihoon')
    return jsonify({"message": f"{name}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š"})

if __name__ == '__main__':
    app.run(port=5000)
```

#### Client
```csharp
using SimpleJSON;
using System.Collections;
using UnityEditor.VersionControl;
using UnityEngine;
using UnityEngine.Networking;
using UnityEngine.UI;

public class HelloAPI : MonoBehaviour
{
    public InputField nameInput;
    public Text resultText;

    public void OnClickHello()
    {
        string name = nameInput.text;
        //StartCoroutine()
    }

    IEnumerator SendRequest(string name)
    {
        string url = "http://localhost:5000/hello?name=" + UnityWebRequest.EscapeURL(name);
        UnityWebRequest req = UnityWebRequest.Get(url);

        yield return req.SendWebRequest();

        if(req.result == UnityWebRequest.Result.Success)
        {
            string json = req.downloadHandler.text;
            string message = JsonUtility.FromJson<Message>(json).message;
            resultText.text = message;
        }
        else
        {
            resultText.text = "ìš”ì²­ ì‹¤íŒ¨: " + req.error;
        }
    }

    [System.Serializable]
    public class Message
    {
        public string message;
    }

}
```


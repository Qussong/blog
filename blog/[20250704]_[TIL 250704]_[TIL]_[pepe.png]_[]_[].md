# Stable Diffusion API 통신

### 📌API 통신 코드 (python ver)
#### 코드
```python
import requests
import base64

# 서버 주소
url = 'http://127.0.0.1:7860/sdapi/v1/txt2img'

# 프롬프트 설정
payload = {
    "prompt": "a fluffy white cat lying on a wooden floor, natural sunlight from the window, photorealistic, ultra detailed, 8k, soft shadow, close-up",
    "negative_prompt": "low quality, blurry, deformed, bad anatomy, bad eyes, cross-eyed, asymmetrical eyes, mutated eyes, fused eyes, extra eyes, extra limbs, cropped, out of frame, watermark, text, nsfw, unnatural colors",
    "steps": 25,
    "cfg_scale": 7.5,
    "sampler_name": "DPM++ 2M",
    "scheduler": "Karras",
}

response = requests.post(url, json=payload)

# base64 이미지 추출
r = response.json()
image_data = r['images'][0]

# 파일로 저장
with open("output.png", "wb") as f:
    f.write(base64.b64decode(image_data))
```
#### 결과물
![스테이블 디퓨전 결과물](img/post/250704/output.png)

#### 코드 분석
sd webui api 에 텍스트 프롬프트를 POST 요청하여 이미지를 생성하는 코드다.</br>
결과 이미지를 base64로 받아와 png로 저장하며 전체 흐름을 담고 있다.</br>
```plainText
1. 라이브러리 임포트
2. 요청 URL 설정
3. 프롬프트와 설정 파라미터 정의
4. 이미지 생성 요청 전송
5. 응답 받아 이미지 추출 및 디코딩
6. 이미지 저장
```
1. 라이브러리 임포트</br>
**request** : HTTP 요청을 위해 사용되는 라이브러리</br> 
**base64** : 응답 이미지가 문자열 형식으로 전달되므로 이를 디코딩하기 위해 사용</br>
2. 요청 URL 설정</br>
SD webui 에서 제공하는 REST API 주소</br>
```plainText
url = 'http://127.0.0.1:7860/sdapi/v1/txt2img'
```
3. 프롬프트와 설정 파라미터 정의</br>
```python
payload = {
    "prompt": "...",              # 생성할 이미지에 대한 설명
    "negative_prompt": "...",     # 피하고 싶은 요소
    "steps": 25,                  # 디퓨전 반복 수 (더 많을수록 품질↑, 속도↓)
    "cfg_scale": 7.5,             # 프롬프트에 대한 충실도 (7~10 권장)
    "sampler_name": "DPM++ 2M",   # 샘플링 알고리즘
    "scheduler": "Karras"         # 샘플링 스케줄러 (노이즈 분포 방식)
}
```
4. 이미지 생성 요청 전송</br>
POST 방식으로 API 호출하고 JSON 형식으로 프롬프트 데이터를 전송한다.</br>
```python
response = requests.post(url, json=payload)
```
5. 응답 받아 이미지 추출 및 디코딩</br>
응답은 JSON 형태이며 images 키 안에 base64 문자열 이미지가 배열로 들어 있다.</br>
```python
r = response.json()
image_data = r['images'][0] # 첫 번째 이미지 선택
```
6. 이미지 저장</br>
base64 문자열 -> 바이너리 데이터로 변환 후 output.png 파일로 저장</br>
```python
with open("output.png", "wb") as f:
    f.write(base64.b64decode(image_data))
```
